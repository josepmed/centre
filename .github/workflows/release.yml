name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build for Apple Silicon
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Build release binary
        run: cargo build --release --target aarch64-apple-darwin

      - name: Create tarball
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          ARCHIVE="centre-${VERSION}-arm64-apple-darwin.tar.gz"

          mkdir -p dist
          cp target/aarch64-apple-darwin/release/centre dist/

          tar -czf "${ARCHIVE}" -C dist centre

          # Generate SHA256 checksum
          shasum -a 256 "${ARCHIVE}" > "${ARCHIVE}.sha256"

          echo "ARCHIVE=${ARCHIVE}" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: centre-arm64
          path: |
            centre-*.tar.gz
            centre-*.tar.gz.sha256

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.sha256" \) -exec cp {} release/ \;
          ls -lah release/

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          generate_release_notes: true
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    name: Update Homebrew Formula
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          repository: josepmed/homebrew-centre
          token: ${{ secrets.TAP_REPO_TOKEN }}
          path: homebrew-centre

      - name: Get release info
        id: release
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Download SHA256 checksum from release assets
          ARM64_SHA=$(curl -sL "https://github.com/josepmed/centre/releases/download/v${VERSION}/centre-${VERSION}-arm64-apple-darwin.tar.gz.sha256" | awk '{print $1}')

          echo "arm64_sha=${ARM64_SHA}" >> $GITHUB_OUTPUT

          echo "Version: ${VERSION}"
          echo "ARM64 SHA: ${ARM64_SHA}"

      - name: Update formula
        run: |
          cd homebrew-centre/Formula
          VERSION=${{ steps.release.outputs.version }}
          ARM64_SHA=${{ steps.release.outputs.arm64_sha }}

          # Update version
          sed -i "s/version \".*\"/version \"${VERSION}\"/" centre.rb

          # Update download URL
          sed -i "s|releases/download/v[0-9.]*/centre-[0-9.]*-arm64|releases/download/v${VERSION}/centre-${VERSION}-arm64|" centre.rb

          # Update SHA256 hash
          sed -i "s/sha256 \"[^\"]*\"/sha256 \"${ARM64_SHA}\"/" centre.rb

          echo "Updated formula:"
          cat centre.rb

      - name: Commit and push
        run: |
          cd homebrew-centre
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/centre.rb
          git commit -m "Update centre to v${{ steps.release.outputs.version }}"
          git push
