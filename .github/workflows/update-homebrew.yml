name: Update Homebrew Formula

on:
  release:
    types: [published]

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          repository: josepmed/homebrew-centre
          token: ${{ secrets.TAP_REPO_TOKEN }}
          path: homebrew-centre

      - name: Get release info
        id: release
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Download SHA256 checksum from release assets
          ARM64_SHA=$(curl -sL "https://github.com/josepmed/centre/releases/download/v${VERSION}/centre-${VERSION}-arm64-apple-darwin.tar.gz.sha256" | awk '{print $1}')

          echo "arm64_sha=${ARM64_SHA}" >> $GITHUB_OUTPUT

          echo "Version: ${VERSION}"
          echo "ARM64 SHA: ${ARM64_SHA}"

      - name: Update formula
        run: |
          cd homebrew-centre/Formula
          VERSION=${{ steps.release.outputs.version }}
          ARM64_SHA=${{ steps.release.outputs.arm64_sha }}

          # Update version
          sed -i "s/version \".*\"/version \"${VERSION}\"/" centre.rb

          # Update download URL
          sed -i "s|releases/download/v[0-9.]*/centre-[0-9.]*-arm64|releases/download/v${VERSION}/centre-${VERSION}-arm64|" centre.rb

          # Update SHA256 hash
          sed -i "s/sha256 \"[^\"]*\"/sha256 \"${ARM64_SHA}\"/" centre.rb

          echo "Updated formula:"
          cat centre.rb

      - name: Commit and push
        run: |
          cd homebrew-centre
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/centre.rb
          git commit -m "Update centre to v${{ steps.release.outputs.version }}"
          git push
